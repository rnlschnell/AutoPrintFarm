import { useState, useMemo } from "react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { MoreHorizontal, Clock, Palette, Plus, GripVertical, LayoutGrid, List, Package, Settings, Thermometer } from "lucide-react";
import { usePrinterWebSocket, type LivePrinterData } from "@/hooks/useWebSocket";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { useToast } from "@/hooks/use-toast";
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragOverlay,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';
import {
  useSortable,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import PrinterDetailsModal from "@/components/PrinterDetailsModal";
import PrinterMaintenanceModal from "@/components/PrinterMaintenanceModal";
import ColorSwatch from "@/components/ColorSwatch";
import PrinterColorSelector from "@/components/PrinterColorSelector";
import { usePrinters, type Printer } from "@/hooks/usePrinters";

// Global color settings - this would normally come from a global store or context
const globalColors = [
  'Galaxy Black|#1a1a1a',
  'Signal White|#ffffff',
  'Transparent Blue|#3b82f6',
  'Red|#ef4444',
  'Green|#22c55e',
  'Yellow|#eab308',
  'Orange|#f97316',
  'Purple|#a855f7'
];

const getStatusBadge = (status: string) => {
    switch (status) {
        case 'printing':
            return <Badge className="bg-blue-600 text-white hover:bg-blue-700">Printing</Badge>;
        case 'idle':
            return <Badge className="bg-green-600 text-white hover:bg-green-700">Idle</Badge>;
        case 'maintenance':
        case 'offline':
            return <Badge variant="destructive">{status.charAt(0).toUpperCase() + status.slice(1)}</Badge>;
        default:
            return <Badge>{status}</Badge>;
    }
};

interface PrinterCardProps {
  printer: Printer;
  liveData?: LivePrinterData;
  onViewDetails: (printer: Printer) => void;
  onStartMaintenance: (printer: Printer) => void;
  isDragging?: boolean;
}

const PrinterCard = ({ printer, liveData, onViewDetails, onStartMaintenance, isDragging = false }: PrinterCardProps) => {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: printer.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    zIndex: isDragging ? 1000 : 'auto',
  };

  // Separate connection status from print job status
  const isConnected = liveData?.is_connected ?? (printer.connected ?? false);
  const connectionStatus = isConnected ? 'connected' : 'offline';
  
  // Get print job status - what the printer is currently doing or last job state
  const printJobStatus = liveData ? liveData.status : (printer.status === 'offline' ? 'idle' : printer.status);
  
  // Get status color for the top border (based on connection, not job status)
  const getStatusColor = () => {
    switch (connectionStatus) {
      case 'connected':
        return 'bg-green-500';
      case 'offline':
        return 'bg-red-500';
      default:
        return 'bg-muted';
    }
  };

  // Get temperatures from live data or fallback to mock data
  const getTemperatures = () => {
    if (liveData?.temperatures) {
      return {
        hotend: Math.round(liveData.temperatures.nozzle.current),
        bed: Math.round(liveData.temperatures.bed.current)
      };
    }
    
    // Fallback to mock data based on connection and print status
    if (!isConnected) {
      return { hotend: 0, bed: 0 };
    }
    
    switch (printJobStatus) {
      case 'printing':
        return { hotend: 215, bed: 60 };
      case 'idle':
        return { hotend: 25, bed: 25 };
      case 'maintenance':
        return { hotend: 180, bed: 0 };
      default:
        return { hotend: 25, bed: 25 }; // Connected but status unknown
    }
  };

  const temperatures = getTemperatures();

  // Memoize printer color to ensure re-renders when color changes
  const printerColor = useMemo(() => {
    return printer.currentColorHex && printer.currentColor 
      ? `${printer.currentColor}|${printer.currentColorHex}`
      : globalColors[0];
  }, [printer.currentColor, printer.currentColorHex, printer.id]);

  // Get progress from live data only - no mock data
  const getProgress = () => {
    if (liveData?.progress && printJobStatus === 'printing') {
      return liveData.progress.percentage;
    }
    
    return 0; // No progress when not printing or no live data available
  };

  const progress = getProgress();
  
  // Get the display text for the progress area
  const getProgressText = () => {
    if (!isConnected) {
      return 'Offline';
    }
    
    switch (printJobStatus) {
      case 'printing':
        if (liveData?.progress) {
          return `${progress}% complete`;
        } else {
          return 'Printing...'; // Show we're printing but don't have progress data yet
        }
      case 'failed':
        return 'Failed';
      case 'cancelled':
      case 'canceled': // Handle both spellings
        return 'Canceled';
      case 'idle':
        return 'Ready';
      case 'maintenance':
        return 'Maintenance';
      default:
        return 'Ready';
    }
  };

  return (
    <Card 
      ref={setNodeRef} 
      style={style}
      className={`flex flex-col overflow-hidden ${isDragging ? 'opacity-30' : ''} relative bg-gradient-to-br from-card to-card/50 border-0 shadow-lg hover:shadow-xl transition-all duration-300`}
    >
      {/* Header Bar */}
      <div className="h-12 flex items-center justify-between px-4" style={{ backgroundColor: '#192A52' }}>
        <div
          className="cursor-grab active:cursor-grabbing flex-shrink-0 touch-none p-1 -ml-1 rounded hover:bg-white/10 transition-colors"
          {...attributes}
          {...listeners}
        >
          <GripVertical className="h-4 w-4 text-white" />
        </div>
        
        <h3 
          className="font-semibold text-white text-center flex-1 truncate px-4 cursor-pointer hover:text-white/80 transition-colors"
          onClick={() => onViewDetails(printer)}
        >
          {printer.name}
        </h3>
        
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button size="sm" variant="ghost" className="h-8 w-8 p-0 hover:bg-white/20 text-white">
              <Settings className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuLabel>Actions</DropdownMenuLabel>
            <DropdownMenuItem onClick={() => onViewDetails(printer)}>
              View Details
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => onStartMaintenance(printer)}>
              Start Maintenance
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>

      {/* Main Content */}
      <div className="flex-1 p-4 space-y-3">
        {/* Status and Progress */}
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className={`w-2 h-2 rounded-full ${getStatusColor()}`} />
              <span className="text-sm font-medium capitalize">
                {connectionStatus === 'connected' ? 'Connected' : 'Offline'}
              </span>
            </div>
            {printJobStatus === 'printing' && (
              <div className="text-right space-y-1">
                <div className="text-xs text-muted-foreground">31/74 layers</div>
              </div>
            )}
          </div>
          <div className="space-y-1">
            <Progress 
              value={printJobStatus === 'printing' ? progress : 0} 
              className="h-2" 
            />
            <div className="flex items-center justify-between text-xs text-muted-foreground">
              <span>{getProgressText()}</span>
              {printJobStatus === 'printing' && (
                <span>1hr 35m left</span>
              )}
            </div>
          </div>
        </div>

        {/* Temperature Display */}
        <div className="space-y-2">
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-1">
              <span className="text-muted-foreground">Hotend:</span>
              <span className="font-medium">{temperatures.hotend}°C</span>
            </div>
            <div className="flex items-center gap-1">
              <span className="text-muted-foreground">Bed:</span>
              <span className="font-medium">{temperatures.bed}°C</span>
            </div>
          </div>
        </div>

        {/* Filament Information */}
        <div className="space-y-1">
          <div className="flex items-center gap-2">
            <ColorSwatch color={printerColor} size="sm" />
            <span className="text-sm font-medium">{printerColor.split('|')[0]}</span>
            <span className="text-sm text-muted-foreground">{printer.currentFilamentType || 'PLA'}</span>
            <PrinterColorSelector printer={printer} />
          </div>
          <div className="text-xs text-muted-foreground">362g left</div>
        </div>
      </div>
    </Card>
  );
};

interface PrinterRowProps {
  printer: Printer;
  liveData?: LivePrinterData;
  onViewDetails: (printer: Printer) => void;
  onStartMaintenance: (printer: Printer) => void;
}

const PrinterRow = ({ printer, liveData, onViewDetails, onStartMaintenance }: PrinterRowProps) => {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: printer.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  // Separate connection status from print job status (same logic as card view)
  const isConnected = liveData?.is_connected ?? (printer.connected ?? false);
  const connectionStatus = isConnected ? 'connected' : 'offline';
  const printJobStatus = liveData ? liveData.status : (printer.status === 'offline' ? 'idle' : printer.status);

  // Memoize printer color to ensure re-renders when color changes
  const printerColor = useMemo(() => {
    return printer.currentColorHex && printer.currentColor 
      ? `${printer.currentColor}|${printer.currentColorHex}`
      : globalColors[0];
  }, [printer.currentColor, printer.currentColorHex, printer.id]);

  return (
    <TableRow ref={setNodeRef} style={style}>
      <TableCell>
        <div className="flex items-center gap-2">
          <div
            className="cursor-grab active:cursor-grabbing"
            {...attributes}
            {...listeners}
          >
            <GripVertical className="h-4 w-4 text-gray-400" />
          </div>
          <div>
            <div className="font-medium">{printer.name}</div>
            <div className="text-sm text-muted-foreground">{printer.model}</div>
          </div>
        </div>
      </TableCell>
      <TableCell>{getStatusBadge(connectionStatus === 'connected' ? 'Connected' : 'Offline')}</TableCell>
      <TableCell className="truncate max-w-32">N/A</TableCell>
      <TableCell>N/A</TableCell>
      <TableCell>
        {printer.currentColor && (
          <div className="flex items-center gap-2">
            <ColorSwatch color={printerColor} size="sm" />
            <span className="truncate">{printerColor.split('|')[0]}</span>
            <span className="text-sm text-muted-foreground">{printer.currentFilamentType || 'PLA'}</span>
            <PrinterColorSelector printer={printer} />
          </div>
        )}
      </TableCell>
      <TableCell>
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button aria-haspopup="true" size="sm" variant="outline">
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuLabel>Actions</DropdownMenuLabel>
            <DropdownMenuItem onClick={() => onViewDetails(printer)}>
              View Details
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => onStartMaintenance(printer)}>
              Start Maintenance
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </TableCell>
    </TableRow>
  );
};

const Printers = () => {
  const { printers, loading, addPrinter, updatePrintersOrder } = usePrinters();
  const { data: liveData, isConnected, isReconnecting } = usePrinterWebSocket();
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);
  const [viewMode, setViewMode] = useState('grid');
  const [selectedPrinter, setSelectedPrinter] = useState<Printer | null>(null);
  const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);
  const [isMaintenanceModalOpen, setIsMaintenanceModalOpen] = useState(false);
  const [activeId, setActiveId] = useState(null);
  const [statusFilter, setStatusFilter] = useState('all');
  const [newPrinter, setNewPrinter] = useState({
    name: '',
    manufacturer: '',
    model: '',
    serialNumber: '',
    ipAddress: '',
    accessCode: ''
  });
  const { toast } = useToast();

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8,
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragStart = (event: any) => {
    setActiveId(event.active.id);
  };

  const handleDragEnd = async (event: any) => {
    const { active, over } = event;
    setActiveId(null);

    if (active.id !== over?.id) {
      const oldIndex = printers.findIndex(printer => printer.id === active.id);
      const newIndex = printers.findIndex(printer => printer.id === over.id);
      
      const newOrder = arrayMove(printers, oldIndex, newIndex);
      
      try {
        await updatePrintersOrder(newOrder);
        toast({
          title: "Printer Order Updated",
          description: "The printer order has been saved.",
        });
      } catch (error) {
        // Error toast is handled in the hook
      }
    }
  };

  const handleAddPrinter = async () => {
    if (!newPrinter.name || !newPrinter.manufacturer || !newPrinter.model) {
      toast({
        title: "Error",
        description: "Please fill in the required fields.",
        variant: "destructive",
      });
      return;
    }

    try {
      await addPrinter({
        ...newPrinter,
        status: 'offline' as const
      });
      setNewPrinter({
        name: '',
        manufacturer: '',
        model: '',
        serialNumber: '',
        ipAddress: '',
        accessCode: ''
      });
      setIsAddModalOpen(false);
    } catch (error) {
      // Error handling is done in the hook
    }
  };

  const handleViewDetails = (printer: Printer) => {
    setSelectedPrinter(printer);
    setIsDetailsModalOpen(true);
  };

  const handleStartMaintenance = (printer: Printer) => {
    setSelectedPrinter(printer);
    setIsMaintenanceModalOpen(true);
  };

  const activePrinter = printers.find(printer => printer.id === activeId);

  // Helper function to get live data for a specific printer
  const getLiveDataForPrinter = (printerIntegerId: number | undefined) => {
    return printerIntegerId ? liveData?.find(data => data.printer_id === printerIntegerId.toString()) : undefined;
  };

  // Filter printers based on status
  const filteredPrinters = statusFilter === 'all' 
    ? printers 
    : printers.filter(printer => {
        // Get live data for this printer to check current status
        const printerLiveData = getLiveDataForPrinter(printer.printerId);
        const printerIsConnected = printerLiveData?.is_connected ?? (printer.connected ?? false);
        const printerJobStatus = printerLiveData ? printerLiveData.status : (printer.status === 'offline' ? 'idle' : printer.status);
        
        switch (statusFilter) {
          case 'printing':
            return printerJobStatus === 'printing';
          case 'idle':
            return printerIsConnected && (printerJobStatus === 'idle' || printerJobStatus === 'ready');
          case 'failed':
            // Show printers with failed print jobs OR disconnected printers
            return printerJobStatus === 'failed' || printerJobStatus === 'cancelled' || printerJobStatus === 'canceled' || !printerIsConnected;
          case 'needs-attention':
            return printerJobStatus === 'maintenance';
          default:
            return true;
        }
      });

  if (loading) {
    return <div className="flex items-center justify-center h-64">Loading printers...</div>;
  }

  return (
    <div className="flex flex-col gap-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Printer Fleet</h1>
          <p className="text-muted-foreground">Manage your connected 3D printers.</p>
        </div>
        <div className="flex items-center gap-4">
          <ToggleGroup type="single" value={viewMode} onValueChange={(value) => value && setViewMode(value)}>
            <ToggleGroupItem value="grid" aria-label="Grid view">
              <LayoutGrid className="h-4 w-4" />
            </ToggleGroupItem>
            <ToggleGroupItem value="list" aria-label="List view">
              <List className="h-4 w-4" />
            </ToggleGroupItem>
          </ToggleGroup>
          <Dialog open={isAddModalOpen} onOpenChange={setIsAddModalOpen}>
            <DialogTrigger asChild>
              <Button>
                <Plus className="mr-2 h-4 w-4" />
                Add Printer
              </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[425px]">
              <DialogHeader>
                <DialogTitle>Add New Printer</DialogTitle>
                <DialogDescription>
                  Add a new 3D printer to your fleet.
                </DialogDescription>
              </DialogHeader>
              <div className="grid gap-4 py-4">
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="name" className="text-right">
                    Name *
                  </Label>
                  <Input
                    id="name"
                    value={newPrinter.name}
                    onChange={(e) => setNewPrinter({ ...newPrinter, name: e.target.value })}
                    className="col-span-3"
                  />
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="manufacturer" className="text-right">
                    Manufacturer *
                  </Label>
                  <Select
                    value={newPrinter.manufacturer}
                    onValueChange={(value) => setNewPrinter({ ...newPrinter, manufacturer: value })}
                  >
                    <SelectTrigger className="col-span-3">
                      <SelectValue placeholder="Select manufacturer" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Bambu Labs">Bambu Labs</SelectItem>
                      <SelectItem value="Other">Other</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="model" className="text-right">
                    Model *
                  </Label>
                  <Select
                    value={newPrinter.model}
                    onValueChange={(value) => setNewPrinter({ ...newPrinter, model: value })}
                  >
                    <SelectTrigger className="col-span-3">
                      <SelectValue placeholder="Select model" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="A1 Mini">A1 Mini</SelectItem>
                      <SelectItem value="A1">A1</SelectItem>
                      <SelectItem value="P1P">P1P</SelectItem>
                      <SelectItem value="P1S">P1S</SelectItem>
                      <SelectItem value="X1C">X1C</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="serial_number" className="text-right">
                    Serial Number
                  </Label>
                  <Input
                    id="serial_number"
                    value={newPrinter.serialNumber}
                    onChange={(e) => setNewPrinter({ ...newPrinter, serialNumber: e.target.value })}
                    className="col-span-3"
                  />
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="ip_address" className="text-right">
                    IP Address
                  </Label>
                  <Input
                    id="ip_address"
                    value={newPrinter.ipAddress}
                    onChange={(e) => setNewPrinter({ ...newPrinter, ipAddress: e.target.value })}
                    className="col-span-3"
                    placeholder="192.168.1.100"
                  />
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="access_code" className="text-right">
                    Access Code
                  </Label>
                  <Input
                    id="access_code"
                    value={newPrinter.accessCode}
                    onChange={(e) => setNewPrinter({ ...newPrinter, accessCode: e.target.value })}
                    className="col-span-3"
                  />
                </div>
              </div>
              <DialogFooter>
                <Button type="submit" onClick={handleAddPrinter}>
                  Add Printer
                </Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        </div>
      </div>

      <div className="mb-4">
        <ToggleGroup 
          type="single" 
          value={statusFilter} 
          onValueChange={(value) => value && setStatusFilter(value)} 
          className="justify-start"
        >
          <ToggleGroupItem value="all" aria-label="All Printers" className="data-[state=on]:bg-primary data-[state=on]:text-primary-foreground">
            All Printers
          </ToggleGroupItem>
          <ToggleGroupItem value="printing" aria-label="Printing" className="data-[state=on]:bg-primary data-[state=on]:text-primary-foreground">
            Printing
          </ToggleGroupItem>
          <ToggleGroupItem value="idle" aria-label="Idle" className="data-[state=on]:bg-primary data-[state=on]:text-primary-foreground">
            Idle
          </ToggleGroupItem>
          <ToggleGroupItem value="failed" aria-label="Failed" className="data-[state=on]:bg-primary data-[state=on]:text-primary-foreground">
            Failed
          </ToggleGroupItem>
          <ToggleGroupItem value="needs-attention" aria-label="Needs Attention" className="data-[state=on]:bg-primary data-[state=on]:text-primary-foreground">
            Needs Attention
          </ToggleGroupItem>
        </ToggleGroup>
      </div>

      {filteredPrinters.length === 0 ? (
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <div className="mx-auto w-24 h-24 bg-muted rounded-full flex items-center justify-center mb-4">
            <Package className="h-12 w-12 text-muted-foreground" />
          </div>
          <h3 className="text-lg font-semibold mb-2">No printers found</h3>
          <p className="text-sm text-muted-foreground mb-4 max-w-sm">
            {statusFilter === 'all' 
              ? "You haven't added any printers to your fleet yet. Add your first printer to get started."
              : `No printers match the "${statusFilter}" filter. Try selecting a different filter or add a new printer.`
            }
          </p>
          {statusFilter === 'all' || printers.length === 0 ? (
            <Button onClick={() => setIsAddModalOpen(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Add Your First Printer
            </Button>
          ) : (
            <Button onClick={() => setStatusFilter('all')}>
              See All Printers
            </Button>
          )}
        </div>
      ) : (
      
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        <SortableContext items={filteredPrinters} strategy={verticalListSortingStrategy}>
          {viewMode === 'grid' ? (
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
              {filteredPrinters.map((printer) => (
                <PrinterCard 
                  key={printer.id} 
                  printer={printer} 
                  liveData={getLiveDataForPrinter(printer.printerId)}
                  onViewDetails={handleViewDetails}
                  onStartMaintenance={handleStartMaintenance}
                />
              ))}
            </div>
          ) : (
            <div className="rounded-md border">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Printer</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead>Current Job</TableHead>
                    <TableHead>Time Left</TableHead>
                    <TableHead>Material</TableHead>
                    <TableHead>Actions</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredPrinters.map((printer) => (
                    <PrinterRow 
                      key={printer.id} 
                      printer={printer} 
                      liveData={getLiveDataForPrinter(printer.printerId)}
                      onViewDetails={handleViewDetails}
                      onStartMaintenance={handleStartMaintenance}
                    />
                  ))}
                </TableBody>
              </Table>
            </div>
          )}
        </SortableContext>
        <DragOverlay>
          {activeId && activePrinter ? (
            viewMode === 'grid' ? (
              <PrinterCard 
                printer={activePrinter}
                onViewDetails={handleViewDetails}
                onStartMaintenance={handleStartMaintenance}
                isDragging={false}
              />
            ) : (
              <div className="bg-background border rounded-md p-4 shadow-lg">
                <div className="flex items-center gap-2">
                  <GripVertical className="h-4 w-4 text-gray-400" />
                  <div>
                    <div className="font-medium">{activePrinter.name}</div>
                    <div className="text-sm text-muted-foreground">{activePrinter.model}</div>
                  </div>
                </div>
              </div>
            )
          ) : null}
        </DragOverlay>
      </DndContext>
      )}

      <PrinterDetailsModal
        printer={selectedPrinter ? printers.find(p => p.id === selectedPrinter.id) || selectedPrinter : null}
        isOpen={isDetailsModalOpen}
        onClose={() => setIsDetailsModalOpen(false)}
      />

      <PrinterMaintenanceModal
        printer={selectedPrinter}
        isOpen={isMaintenanceModalOpen}
        onClose={() => setIsMaintenanceModalOpen(false)}
      />
    </div>
  );
};

export default Printers;
